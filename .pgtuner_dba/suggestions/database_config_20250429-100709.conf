# Read this disclaimer before applying the tuning result
# ============================================================
# PGTUNER_DBA-v0.1.4: The tuning is started at 2025-04-29 10:07:09.088786+00:00 
# -> Target Scope: PGTUNER_SCOPE.DATABASE_CONFIG
# DISCLAIMER: This database tuning options is based on our experience, and should not be 
# applied directly to the system. There is ZERO guarantee that this tuning guideline is 
# the best for your system, for every tables, indexes, workload, and queries. Please 
# consult with your database administrator or software/system delivery manager before
# applying the tuning result.
# HOWTO: It is recommended to apply the tuning result under the /etc/postgresql/* directory 
# or inside the $PGDATA/conf/* or $PGDATA/* directory depending on how you start your
# PostgreSQL server. Please double check the system from the SQL interactive sessions to 
# ensure things are working as expected. Whilst it is possible to start the PostgreSQL 
# server with the new configuration, it could result in lost of configuration (such as new 
# version update, unknown configuration changes, extension or external configuration from 
# 3rd-party tools, or no inherited configuration from the parent directory). It is not 
# recommended to apply the tuning result directly to the system without a proper backup, 
# and ensure the system is capable of rolling back the changes if the system is not working.
# ============================================================

# User Options: {'workload_profile': <PG_SIZING.LARGE: 'large'>, 'pgsql_version': 17, 'data_index_spec': {'random_iops_spec': 30000, 'random_iops_scale_factor': 0.9, 'throughput_spec': 500, 'throughput_scale_factor': 0.9, 'per_scale_in_raid': 0.75, 'num_disks': 1, 'disk_usable_size': 536870912000}, 'wal_spec': {'random_iops_spec': 30000, 'random_iops_scale_factor': 0.9, 'throughput_spec': 500, 'throughput_scale_factor': 0.9, 'per_scale_in_raid': 0.75, 'num_disks': 1, 'disk_usable_size': 536870912000}, 'max_backup_replication_tool': <PG_BACKUP_TOOL.PG_BASEBACKUP: 'pg_basebackup [--incremental] or streaming replication (byte-capture change): Byte-level backup'>, 'opt_transaction_lost': <PG_PROFILE_OPTMODE.NONE: 'none'>, 'opt_wal_buffers': <PG_PROFILE_OPTMODE.SPIDEY: 'lightweight'>, 'max_time_transaction_loss_allow_in_millisecond': 650, 'max_num_stream_replicas_on_primary': 0, 'max_num_logical_replicas_on_primary': 0, 'offshore_replication': False, 'workload_type': <PG_WORKLOAD.HTAP: 'htap'>, 'opt_mem_pool': <PG_PROFILE_OPTMODE.OPTIMUS_PRIME: 'general'>, 'tuning_kwargs': {'user_max_connections': 0, 'superuser_reserved_connections_scale_ratio': 1.5, 'single_memory_connection_overhead': 5242880, 'memory_connection_to_dedicated_os_ratio': 0.3, 'effective_cache_size_available_ratio': 0.985, 'shared_buffers_ratio': 0.3284510642791226, 'max_work_buffer_ratio': 0.12730070951941508, 'effective_connection_ratio': 0.75, 'temp_buffers_ratio': 0.25, 'max_normal_memory_usage': 0.45, 'mem_pool_tuning_ratio': 0.6, 'hash_mem_usage_level': -6, 'mem_pool_parallel_estimate': True, 'max_query_length_in_bytes': 2048, 'max_runtime_ms_to_log_slow_query': 2000, 'max_runtime_ratio_to_explain_slow_query': 1.5, 'wal_segment_size': 16777216, 'min_wal_size_ratio': 0.05, 'max_wal_size_ratio': 0.05, 'wal_keep_size_ratio': 0.05, 'autovacuum_utilization_ratio': 0.8, 'vacuum_safety_level': 2}, 'database_size_in_gib': 300, 'num_write_transaction_per_hour_on_workload': 50000, 'operating_system': 'linux', 'vcpu': 4, 'total_ram': 17179869184, 'base_kernel_memory_usage': 805306368, 'base_monitoring_memory_usage': 268435456, 'enable_sysctl_general_tuning': False, 'enable_sysctl_correction_tuning': False, 'enable_database_general_tuning': True, 'enable_database_correction_tuning': True, 'align_index': 0}
## ===== SCOPE: PG_SCOPE.CONNECTION ===== 
superuser_reserved_connections = 3
reserved_connections = 4
max_connections = 37
listen_addresses = '*'

## ===== SCOPE: PG_SCOPE.MEMORY ===== 
shared_buffers = 5045MB
temp_buffers = 14408kB
work_mem = 43240kB
hash_mem_multiplier = 2.125

## ===== SCOPE: PG_SCOPE.MAINTENANCE ===== 
autovacuum = on
autovacuum_max_workers = 2
autovacuum_naptime = 45s
maintenance_work_mem = 960MB
autovacuum_work_mem = -1
autovacuum_vacuum_threshold = 2000
autovacuum_vacuum_insert_threshold = 2000
autovacuum_analyze_threshold = 2000
autovacuum_vacuum_scale_factor = 0.005
autovacuum_vacuum_insert_scale_factor = 0.005
autovacuum_analyze_scale_factor = 0.005
autovacuum_vacuum_cost_delay = 5ms
autovacuum_vacuum_cost_limit = -1
vacuum_cost_delay = 0ms
vacuum_cost_limit = 455
vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 3
vacuum_cost_page_dirty = 10
autovacuum_freeze_max_age = 1612750000
vacuum_freeze_table_age = 1370750000
vacuum_freeze_min_age = 20000000
autovacuum_multixact_freeze_max_age = 1613000000
vacuum_multixact_freeze_table_age = 1371000000
vacuum_multixact_freeze_min_age = 2000000
vacuum_buffer_usage_limit = 315MB
vacuum_failsafe_age = 1899000000
vacuum_multixact_failsafe_age = 1899000000

## ===== SCOPE: PG_SCOPE.OTHERS ===== 
bgwriter_delay = 100ms
bgwriter_lru_maxpages = 450
bgwriter_lru_multiplier = 2.0
bgwriter_flush_after = 1024kB
effective_io_concurrency = 192
maintenance_io_concurrency = 96
backend_flush_after = 1048576
max_worker_processes = 8
max_parallel_workers = 4
max_parallel_workers_per_gather = 2
max_parallel_maintenance_workers = 2
min_parallel_table_scan_size = 24576kB
min_parallel_index_scan_size = 1536kB
idle_in_transaction_session_timeout = 301s
statement_timeout = 1803s
lock_timeout = 1800s
deadlock_timeout = 1s
idle_session_timeout = 0s
transaction_timeout = 0s

## ===== SCOPE: PG_SCOPE.ARCHIVE_RECOVERY_BACKUP_RESTORE ===== 
wal_level = replica
synchronous_commit = on
full_page_writes = on
fsync = on
wal_compression = zstd
wal_init_zero = on
wal_recycle = on
wal_log_hints = on
wal_writer_delay = 200ms
wal_writer_flush_after = 4MB
checkpoint_timeout = 15min
checkpoint_flush_after = 1024kB
checkpoint_completion_target = 0.9
checkpoint_warning = 90s
min_wal_size = 25600MB
max_wal_size = 25600MB
wal_buffers = 98304kB
archive_mode = on
archive_command = '#!/bin/sh
set -euox pipefail

if [ "$PG_ENABLED_ARCHIVE" == "true" ]; then
    if [ "$PG_ENABLED_ARCHIVE_COMPRESSION" == "gzip" && command -v gzip &> /dev/null ]; then
        alias gzip = "$(command -v gzip)"
        gzip -k -v -c "%p" > /var/lib/postgresql/mnt/archive/wal/%f.gz
    elif [ "$PG_ENABLED_ARCHIVE_COMPRESSION" == "lz4" && command -v lz4 &> /dev/null ]; then
        alias lz4 = "$(command -v lz4)"
        lz4 -k -v "%p" /var/lib/postgresql/mnt/archive/wal/%f.lz4
    elif [ "$PG_ENABLED_ARCHIVE_COMPRESSION" == "zstd" && command -v zstd &> /dev/null ]; then
        alias zstd = "$(command -v zstd)"
        zstd -k -v "%p" -o /var/lib/postgresql/mnt/archive/wal/%f.zst
    else
        cp "%p" /var/lib/postgresql/mnt/archive/wal/%f
    fi
fi
exit '
archive_timeout = 1800s
restore_command = '#!/bin/sh
set -euox pipefail

if [ "$PG_ENABLED_ARCHIVE" == "true" ]; then
    if [ "$PG_ENABLED_ARCHIVE_COMPRESSION" == "gzip" && command -v gzip &> /dev/null ]; then
        alias gzip = "$(command -v gzip)"
        gzip -d -c -k -v /var/lib/postgresql/mnt/archive/wal/%f.gz > "%p"
    elif [ "$PG_ENABLED_ARCHIVE_COMPRESSION" == "lz4" && command -v lz4 &> /dev/null ]; then
        alias lz4 = "$(command -v lz4)"
        lz4 -d -k -v /var/lib/postgresql/mnt/archive/wal/%f.lz4 "%p"
    elif [ "$PG_ENABLED_ARCHIVE_COMPRESSION" == "zstd" && command -v zstd &> /dev/null ]; then
        alias zstd = "$(command -v zstd)"
        zstd -d -k -v /var/lib/postgresql/mnt/archive/wal/%f.zst -o "%p"
    else
        cp /var/lib/postgresql/mnt/archive/wal/%f "%p"
    fi
fi
exit '
archive_cleanup_command = 'pg_archivecleanup /var/lib/postgresql/mnt/archive/wal %r'
summarize_wal = on
wal_summary_keep_time = 43200min
max_wal_senders = 3
max_replication_slots = 3
wal_keep_size = 25600MB
max_slot_wal_keep_size = -1
wal_sender_timeout = 60s
track_commit_timestamp = on
logical_decoding_work_mem = 64MB

## ===== SCOPE: PG_SCOPE.QUERY_TUNING ===== 
seq_page_cost = 1.0
random_page_cost = 1.2
cpu_tuple_cost = 0.025
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.001
effective_cache_size = 10115MB
default_statistics_target = 500
parallel_setup_cost = 1000
parallel_tuple_cost = 0.1
commit_delay = 1000
commit_siblings = 11
track_activity_query_size = 2048B
track_counts = on
track_io_timing = on
track_wal_io_timing = on

## ===== SCOPE: PG_SCOPE.LOGGING ===== 
logging_collector = on
log_destination = stderr
log_directory = log
log_filename = 'postgresql-%Y-%m-%d_%H%M.log'
log_rotation_age = 24h
log_rotation_size = 256MB
log_truncate_on_rotation = on
log_autovacuum_min_duration = 300s
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = on
log_error_verbosity = VERBOSE
log_line_prefix = '%m [%p] %quser=%u@%r@%a_db=%d,backend=%b,xid=%x %v,log=%l'
log_lock_waits = on
log_recovery_conflict_waits = on
log_statement = mod
log_replication_commands = on
log_min_duration_statement = 2000ms
log_min_error_statement = ERROR
log_parameter_max_length = 2048B
log_parameter_max_length_on_error = 2048B
log_startup_progress_interval = 1000

## ===== SCOPE: PG_SCOPE.EXTRA ===== 
shared_preload_libraries = 'auto_explain,pg_prewarm,pgstattuple,pg_stat_statements,pg_buffercache,pg_visibility'
auto_explain.log_min_duration = 3000ms
auto_explain.log_analyze = off
auto_explain.log_buffers = on
auto_explain.log_wal = on
auto_explain.log_settings = off
auto_explain.log_triggers = off
auto_explain.log_verbose = on
auto_explain.log_format = text
auto_explain.log_level = LOG
auto_explain.log_timing = on
auto_explain.log_nested_statements = off
auto_explain.sample_rate = 1.0
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.track_planning = off
pg_stat_statements.save = on

